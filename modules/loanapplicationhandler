"use strict";

let mongoose = require("mongoose"),
        db = mongoose.connect(process.env.MONGODB_URI),
        formatter = require('./formatter'),
        LoanApplication = require("../models/loanapplication");
        
mongoose.Promise = global.Promise;
        

exports.createLoanApp = (userid,update) => {
    console.log(userid + ' ' + update);
    var query = {user_id: userid};
    var options = {upsert: true};
    return new Promise((resolve, reject) => {
        LoanApplication.updateOne(query, update, options,(err,loanApp)=> {
            if (err) {
                 reject("An error as occurred");
            } else {
                resolve(loanApp);
            }
        });
    });
};

exports.updateLoanApp = (userid,update) => {
    console.log(userid + ' ' + update);
    var filter = {user_id: userid};
    var options = {upsert: true, returnNewDocument : true};
    return new Promise((resolve, reject) => {
        LoanApplication.updateOne(filter, update,(err,loanApp) =>{
            if (err) {
                 reject("An error as occurred");
            } else {
                console.log(loanApp.user_id);
                resolve(loanApp);
            }
        });
    });
};

exports.findLoanApp = (userid) => {
    var filter = {user_id: userid};
    return new Promise((resolve, reject) => {
        LoanApplication.findOne(filter,(err,loanApp) =>{
            if (err) {
                 reject("An error as occurred");
            } else {
                console.log(loanApp.user_id);
                resolve(loanApp);
            }
        });
    });
};

exports.createFirstQuestion=()=>{
        var options = [
            'Primary Residence','Secondary Residence','Investment'
        ];
        var postbacks = 'startApplication,askSecondQuestion,occupancy_type';
        var question = 'I will walk you through a series of questions to gather some information. Once we complete these steps, I can send you a preapproval form. So let\'s get started, what is this property for?';
        return formatter.formatApplicationQuestions(question,postbacks,options);
};

exports.createSecondQuestion=()=>{
        var options = [
            'House','Condo','Town House','Multi-Family','Land','Other Type'    
        ];
        var postbacks = 'startApplication,askThirdQuestion,property_type';
        var question = 'What is the type of asset?';
        return formatter.formatApplicationQuestions(question,postbacks,options);
};

exports.createThirdQuestion=()=>{
        return {text: `what is your email address?`};
};

exports.createFourthQuestion=()=>{
        return {text: `what is your phone number?`};
};

exports.createFifthQuestion=(loanapp)=>{
        var options = [
            'Yes','No'    
        ];
        var postbacks = 'startApplication,processLoanApplication';
        var question = 'You want a pre-approval for ' + loanapp.property_type + ' that you will use as ' + loanapp.occupancy_type + ', correct?'  ;
        return formatter.formatApplicationQuestions(question,postbacks,options);
};
